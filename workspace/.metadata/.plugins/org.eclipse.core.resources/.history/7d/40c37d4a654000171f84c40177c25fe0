package be.project.middleware;

import java.awt.Desktop;
import java.net.URI;

import spark.Spark;

public class Main {


	interface PinOperation { boolean operate(byte[] pin); }

	
	private static final spark.Service serv = spark.Service.ignite();
	
	/**
	 * @param args
	 */
	public static void main(String[] args) {
		final Commands cm = new Commands();
		cm.init();
		
		askForPin((pin) -> {
			return cm.sendPIN(pin);
		});
		
		serv.post("authenticatesp", (req, res) -> {
			String cert = req.queryParams("cert");
			byte[] certBytes = cert.getBytes();
			try {
				byte[] keyAndMessage = cm.authenticateSP(certBytes);
				return keyAndMessage.toString();				
			} catch(Exception e) {
				return "Error: " + e.getMessage();
			}
		});
		
		serv.post("authenticatespchallenge", (req, res) -> {
			String challenge = req.queryParams("challenge");
			byte[] challengeBytes = challenge.getBytes();
			try {
				cm.authenticateSPChallenge(challengeBytes);
				return "ok";				
			} catch(Exception e) {
				return "Error: " + e.getMessage();
			}
		});	
		
		serv.post("authenticatecard", (req, res) -> {
			String challenge = req.queryParams("challenge");
			byte[] challengeBytes = challenge.getBytes();
			try {
				byte[] Emsg = cm.authenticateCard(challengeBytes);
				return Emsg; // TODO gaat niet werken				
			} catch(Exception e) {
				return "Error: " + e.getMessage();
			}
		});
		
		serv.post("queryattribute", (req, res) -> {
			askForPin
			byte[] Eattributes = cm.getAttributes();
			return Eattributes;
		});
		
		
	}
	
	public static void askForPin(final PinOperation cont, final VoidOperation then) {
		spark.Service pinServ = spark.Service.ignite();
		final Counter tries = new Counter();
		pinServ.port(4568);
		pinServ.get("/pin", (req, res) -> ("<form method=\"POST\">" +
				"    Tries left: " + (3 - tries.val()) + "<br />" +
				"    PIN:<input type=\"text\" name=\"pin\" pattern=\"[0-9]{4}\" maxlength=\"4\">" +
				"    <input type=\"submit\" value=\"Validate\">" +
				"</form>"));
		
		pinServ.post("/pin", (req, res) -> { // TODO pin wrong
			String pin = req.queryParams("pin");
			String[] pp = pin.split("");
			int i = 0;
			byte[] pinarr = new byte[4];
			for(String num : pp) {
				pinarr[i] = Byte.parseByte(num);
				i++;
			}
			if(cont.operate(pinarr)) {
				pinServ.stop();
				return "OK";				
			} else {
				if(tries.val() == 3) {
					pinServ.stop();
					return "Too many tries";
				} else {
					tries.plus();
					res.redirect("/pin");
					return res;					
				}
			}
		});
		
		// Open browser
		try {
			Desktop.getDesktop().browse(new URI("http://localhost:4568/pin"));			
		} catch(Exception e ) {
			System.out.println("Opening browser failed");
		}

	}


}
