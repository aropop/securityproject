package be.project.middleware;

import java.awt.Desktop;
import java.net.URI;

import spark.Spark;

public class Main {


	interface PinOperation { void operate(byte[] pin); }
	
	private static final spark.Service serv = spark.Service.ignite();
	
	/**
	 * @param args
	 */
	public static void main(String[] args) {
		final Commands cm = new Commands();
		cm.init();
		
		askForPin((pin) -> {
			cm.sendPIN(pin);
		});
		
		serv.post("authenticatesp", (req, res) -> {
			String cert = req.queryParams("cert");
			byte[] certBytes = cert.getBytes();
			try {
				byte[] keyAndMessage = cm.authenticateSP(certBytes);
				return keyAndMessage.toString();				
			} catch(Exception e) {
				return "Error: " + e.getMessage();
			}
		});
		
		serv.post("authenticatespchallenge", (req, res) -> {
			String challenge = req.queryParams("challenge");
			byte[] challengeBytes = challenge.getBytes();
			try {
				cm.authenticateSPChallenge(challengeBytes);
				return "ok";				
			} catch(Exception e) {
				return "Error: " + e.getMessage();
			}
		});
		
		
		
		
	}
	
	public static void askForPin(final PinOperation cont) {
		serv.get("/pin", (req, res) -> ("<form method=\"POST\">" +
				"    PIN:<input type=\"text\" name=\"pin\" pattern=\"[0-9]{4}\" maxlength=\"4\">" +
				"    <input type=\"submit\" value=\"Validate\">" +
				"</form>"));
		serv.post("/pin", (req, res) -> {
			String pin = req.queryParams("pin");
			String[] pp = pin.split("");
			int i = 0;
			byte[] pinarr = new byte[4];
			for(String num : pp) {
				pinarr[i] = Byte.parseByte(num);
				i++;
			}
			Spark.stop();
			
			cont.operate(pinarr);
			return true;
		});
		try {
			Desktop.getDesktop().browse(new URI("http://localhost:4567/pin"));			
		}catch(Exception e ) {
			System.out.println("Opening browser failed");
		}

	}


}
